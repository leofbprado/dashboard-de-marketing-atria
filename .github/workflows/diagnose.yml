name: Diagnose Server

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add host to known_hosts
        run: ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Deep diagnose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            echo "=== ALL PM2 PROCESSES (all users) ==="
            pm2 jlist 2>/dev/null | python3 -m json.tool 2>/dev/null || pm2 list
            echo ""
            echo "=== PROCESS TREE ON PORT 3000 ==="
            lsof -i :3000 2>/dev/null || ss -tlnp | grep 3000
            echo ""
            echo "=== DEPLOY PATH ==="
            echo "Path: ${{ secrets.DEPLOY_PATH }}"
            ls -la ${{ secrets.DEPLOY_PATH }}/ 2>/dev/null | head -30
            echo ""
            echo "=== DEPLOY PATH package.json ==="
            cat ${{ secrets.DEPLOY_PATH }}/package.json 2>/dev/null | head -20
            echo ""
            echo "=== PM2 CWD FOR DASHBOARD ==="
            pm2 describe dashboard 2>/dev/null | grep -E 'cwd|script|exec' || echo "no dashboard"
            echo ""
            echo "=== FIND ALL next.config FILES ==="
            find / -name "next.config.*" -not -path "*/node_modules/*" 2>/dev/null | head -20
            echo ""
            echo "=== FIND ALL package.json WITH NEXT ==="
            find / -maxdepth 5 -name "package.json" -not -path "*/node_modules/*" -exec grep -l "next" {} \; 2>/dev/null | head -20
            echo ""
            echo "=== PM2 ECOSYSTEM FILES ==="
            find / -name "ecosystem.config.*" -not -path "*/node_modules/*" 2>/dev/null | head -10
            echo ""
            echo "=== SYSTEMD SERVICES ==="
            systemctl list-units --type=service --state=running 2>/dev/null | grep -iE 'next|node|motor|marketing' || echo "none found"
